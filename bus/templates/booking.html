{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="user-id" content="{{ request.user.id }}" />
  <title>Book Ticket - BusTicketPro</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    .seat {
      transition: all 0.3s ease;
    }
    .seat:hover {
      transform: scale(1.05);
      cursor: pointer;
    }
    .seat.selected {
      animation: pulse 0.4s ease-in-out;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); background-color: #38a169; }
      50% { transform: scale(1.1); background-color: #2f855a; }
      100% { transform: scale(1); background-color: #38a169; }
    }
    .legend-dot {
      width: 1rem; height: 1rem; border-radius: 50%;
      display: inline-block; margin-right: 0.4rem;
    }
    .glassy-3d-card {
      background: linear-gradient(135deg, rgba(255,255,255,0.75) 60%, rgba(96,165,250,0.13) 100%);
      box-shadow: 0 12px 48px 0 rgba(31, 38, 135, 0.18), 0 1.5px 8px 0 #60a5fa22;
      border-radius: 2rem;
      border: 1.5px solid rgba(30, 64, 175, 0.13);
    }
    .modern-input {
      background: rgba(255,255,255,0.55);
      border: 1.5px solid #60a5fa44;
      border-radius: 1.2rem;
      box-shadow: 0 2px 12px 0 #60a5fa22;
      padding: 1rem 1.25rem;
      font-size: 1.08rem;
      font-weight: 500;
      color: #1e293b;
      transition: all 0.22s cubic-bezier(.4,0,.2,1);
      outline: none;
    }
    .modern-input:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px #60a5fa33, 0 2px 12px 0 #2563eb22;
      background: rgba(255,255,255,0.85);
    }
    .floating-label-modern {
      position: absolute;
      left: 1.5rem;
      top: 50%;
      transform: translateY(-50%);
      color: #60a5fa;
      pointer-events: none;
      transition: all 0.2s cubic-bezier(.4,0,.2,1);
      font-size: 1.08rem;
      background: transparent;
      font-weight: 600;
    }
    .modern-input:focus + .floating-label-modern,
    .modern-input:not(:placeholder-shown) + .floating-label-modern {
      top: -0.9rem;
      left: 1.1rem;
      font-size: 0.92rem;
      color: #2563eb;
      background: #fff;
      padding: 0 0.4rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 8px 0 #60a5fa22;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-300/60 via-white/80 to-blue-100/60 min-h-screen font-sans text-gray-800">
  {% include 'header.html' %}

  <section class="py-10 px-2 md:px-4 max-w-6xl mx-auto">
    <h2 class="text-3xl font-bold text-center text-blue-800 mb-6">üéüÔ∏è Book Your Ticket</h2>

    {% if error %}
    <div class="bg-red-100 text-red-700 p-4 rounded mb-4">{{ error }}</div>
    {% endif %}

    {% if schedule %}
    <div class="glassy-3d-card rounded-2xl shadow-lg p-6 mb-10">
      <h3 class="text-xl font-semibold mb-4">Schedule Details</h3>
      <div class="grid md:grid-cols-2 gap-4 mb-6">
        <div><strong>From:</strong> {{ schedule.route.origin }}</div>
        <div><strong>To:</strong> {{ schedule.route.destination }}</div>
        <div><strong>Departure:</strong> {{ schedule.departure_time|date:'Y-m-d H:i' }}</div>
        <div><strong>Bus:</strong> {{ schedule.bus.name }} ({{ schedule.bus.bus_type }})</div>
        <div><strong>Fare per seat:</strong> ‡ß≥{{ schedule.fare }}</div>
      </div>
    </div>

    {% if user_maxed_out %}
    <div class="bg-red-100 border border-red-300 text-red-700 text-lg font-semibold rounded p-6 text-center mb-10">
      üö´ You have already booked the maximum allowed seats (4) for this bus and schedule.<br>
      Please check your bookings or choose another schedule.
    </div>
    {% else %}
    <div class="grid md:grid-cols-3 gap-8">
        <!-- Seat Layout -->
        <div class="md:col-span-2 glassy-3d-card rounded-2xl shadow p-6">
            <h3 class="text-xl font-semibold mb-4 text-center">üöå Select Your Seats</h3>
            <div class="flex justify-center">
                <div id="seat-map" class="flex flex-col items-center gap-4">
                    <!-- Rows will be generated by JS -->
                </div>
            </div>
            <div class="seat-legend flex justify-center mt-4 text-sm text-gray-500">
                <div class="flex items-center mr-4"><span class="w-4 h-4 bg-gray-200 rounded-sm inline-block mr-2"></span> Available</div>
                <div class="flex items-center mr-4"><span class="w-4 h-4 bg-green-500 rounded-sm inline-block mr-2"></span> Selected</div>
                <div class="flex items-center mr-4"><span class="w-4 h-4 bg-red-400 rounded-sm inline-block mr-2"></span> Booked</div>
                <div class="flex items-center mr-4"><span class="w-4 h-4 bg-yellow-400 rounded-sm inline-block mr-2"></span> Temporarily Selected (You)</div>
                <div class="flex items-center"><span class="w-4 h-4 bg-orange-400 rounded-sm inline-block mr-2"></span> Temporarily Selected (Others)</div>
            </div>
        </div>

        <!-- Booking Form & Summary -->
        <div class="glassy-3d-card rounded-2xl shadow p-6">
            <h3 class="text-xl font-semibold mb-4">Booking Details</h3>
            <form id="booking-form" method="post" class="space-y-4">
                {% csrf_token %}
                <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
                <div>
                    <label for="name" class="block font-medium mb-1">Full Name</label>
                    <input type="text" id="name" name="name" required class="modern-input">
                </div>
                <div>
                    <label for="phone" class="block font-medium mb-1">Phone Number</label>
                    <input type="tel" id="phone" name="phone" required pattern="[0-9]{11}" placeholder="01XXXXXXXXX" class="modern-input">
                    <p class="text-sm text-gray-500 mt-1">Please enter a valid Bangladesh phone number (11 digits)</p>
                </div>
                <div>
                    <label for="email" class="block font-medium mb-1">Email</label>
                    <input type="email" id="email" name="email" required class="modern-input">
                </div>

                <div id="selected-seats-container"></div>

                <div class="font-semibold">Selected Seats: <span id="selected-seats-display">None</span></div>
                <div class="font-bold text-lg">Total Price: <span id="total-price">‡ß≥0</span></div>

                <button type="submit" class="w-full px-8 py-4 bg-gradient-to-r from-blue-600 via-blue-400 to-blue-500 text-white rounded-xl font-extrabold text-lg shadow-xl hover:scale-105 hover:from-blue-700 hover:to-blue-500 focus:ring-4 focus:ring-blue-300 transition-all duration-200">Book Now</button>
            </form>
        </div>
    </div>
    {% endif %}
    {% else %}
    <div class="bg-yellow-100 text-yellow-800 p-4 rounded">No schedule selected. Please go to the <a href="{% url 'schedule' %}" class="underline">schedule page</a> to select a bus.</div>
    {% endif %}
  </section>

  {% if schedule %}
  {{ booked_seats|json_script:"booked-seats-data" }}
  <input type="hidden" name="schedule_id" value="{{ schedule.id }}" />
  <script src="{% static 'js/real_time_seats.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const seatMap = document.getElementById('seat-map');
        const selectedSeatsDisplay = document.getElementById('selected-seats-display');
        const totalPriceDisplay = document.getElementById('total-price');
        const selectedSeatsContainer = document.getElementById('selected-seats-container');

        const capacity = parseInt('{{ schedule.bus.capacity }}');
        const fare = parseFloat('{{ schedule.fare }}');
        const bookedSeats = JSON.parse(document.getElementById('booked-seats-data').textContent);
        let selectedSeats = [];
        const seatsPerRow = 4;

        function getSeatName(seatNumber) {
            if (seatNumber <= 0) return '';
            const row = String.fromCharCode(65 + Math.floor((seatNumber - 1) / seatsPerRow)); // 65 is 'A'
            const col = (seatNumber - 1) % seatsPerRow + 1;
            return `${row}${col}`;
        }

        // Generate seat map row by row
        let currentRow;
        for (let i = 1; i <= capacity; i++) {
            // Create a new row div at the start of each row
            if ((i - 1) % seatsPerRow === 0) {
                currentRow = document.createElement('div');
                currentRow.classList.add('flex', 'flex-row', 'gap-4');
                seatMap.appendChild(currentRow);
            }

            const seat = document.createElement('div');
            seat.classList.add('seat', 'w-12', 'h-12', 'flex', 'items-center', 'justify-center', 'rounded-md', 'font-semibold', 'cursor-pointer', 'transition');
            seat.innerText = getSeatName(i);
            seat.dataset.seatNumber = i;

            if (bookedSeats.includes(i)) {
                seat.classList.add('bg-red-400', 'text-white', 'cursor-not-allowed');
                seat.dataset.status = 'booked';
            } else {
                seat.classList.add('bg-gray-200', 'hover:bg-gray-300');
                seat.dataset.status = 'available';
            }
            
            currentRow.appendChild(seat);

            // Add aisle spacer after the 2nd seat in each row
            if (i % seatsPerRow === 2) {
                const aisle = document.createElement('div');
                aisle.classList.add('w-8'); // This creates the space for the aisle
                currentRow.appendChild(aisle);
            }
        }

        // Initialize Real-time Seat Manager
        const scheduleId = parseInt('{{ schedule.id }}');
        const userId = parseInt('{{ request.user.id }}');
        
        if (scheduleId && userId) {
            const seatManager = new RealTimeSeatManager(scheduleId, userId);
            seatManager.initialize().then(() => {
                console.log('Real-time seat manager initialized successfully');
            }).catch(error => {
                console.error('Failed to initialize seat manager:', error);
            });
        }

        // Handle seat click for form submission (legacy functionality)
        seatMap.addEventListener('click', (e) => {
            if (e.target.classList.contains('seat') && e.target.dataset.status === 'available') {
                const seatNumber = parseInt(e.target.dataset.seatNumber);
                const seatIndex = selectedSeats.indexOf(seatNumber);

                if (seatIndex > -1) {
                    // Deselect seat
                    selectedSeats.splice(seatIndex, 1);
                    e.target.classList.remove('bg-green-500', 'text-white');
                    e.target.classList.add('bg-gray-200');
                } else {
                    // Select seat
                    selectedSeats.push(seatNumber);
                    e.target.classList.add('bg-green-500', 'text-white');
                    e.target.classList.remove('bg-gray-200');
                }
                updateBookingSummary();
            }
        });

        function updateBookingSummary() {
            // Update selected seats display
            const seatNames = selectedSeats.map(num => getSeatName(num)).sort();
            if (seatNames.length > 0) {
                selectedSeatsDisplay.innerText = seatNames.join(', ');
            } else {
                selectedSeatsDisplay.innerText = 'None';
            }

            // Update total price
            totalPriceDisplay.innerText = `‡ß≥${selectedSeats.length * fare}`;

            // Update hidden form inputs
            selectedSeatsContainer.innerHTML = '';
            selectedSeats.forEach(seat => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'seats';
                input.value = seat;
                selectedSeatsContainer.appendChild(input);
            });
        }
    });
  </script>
  {% endif %}
</body>
</html>
